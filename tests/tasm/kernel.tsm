include stdlib.tsm
include string.tsm

section kernel-data
    u32 MAX_MEMORY_ALLOC    0x10000000

section kernel
    ; Cleans up and stops the TPU
    syscall_22:
        hlt

    _kernel_start:
        ; Populate syscall table
        setsyscall 22, syscall_22

        ; Start user program
        uret @0x00040000, @0x01000000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

section data
    strz WELCOME_MSG "Welcome to TPUOS\n"

section text
    toast:
        pushdw RP       ; Save RP

        ; Calculate welcome message length
        mov ESI, WELCOME_MSG
        call strlen

        ; Write welcome message
        mov EBX, EAX    ; Save strlen(WELCOME_MSG)
        mov EAX, 1      ; Write() syscall
        syscall

        popdw RP        ; Restore RP
        ret

    _start:
        ; Toast the user
        call toast

        ; Wait 3 seconds
        mov EAX, 3
        call sleep

        ; Put seconds since Epoch in EBX
        mov EAX, 9      ; Time() syscall
        syscall

        ; Kill the TPU
        mov EAX, 22
        syscall
