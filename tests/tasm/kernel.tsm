include stdio.tsm
include stdlib.tsm
include string.tsm

section kernel-data
    u32 MAX_MEMORY_ALLOC    0x10000000

section kernel
    ; Cleans up and stops the TPU
    syscall_22:
        mov EAX, 0 ; Indicate success
        hlt

    _kernel_start:
        ; Populate syscall table
        setsyscall 22, syscall_22

        ; Start user program
        uret @0x00040000, @0x01000000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

section data
    strz PROMPT  "root@tpu-os$ "
    strz NEWLINE "\n"

    ; Buffer for user commands
    space buf  2048
    u32 bufLen 2048

    ; User command strings
    strz CMD_UNKNOWN "Unknown command: "
    strz CMD_EXIT "exit"

section text
    cli:
        pushdw RP       ; Save RP

        __cli_loop:
            ; Clear buffer
            mov ESI, buf
            ldw EAX, bufLen
            call memzero

            ; Write prompt
            mov ESI, PROMPT
            call printz

            ; Read buffer
            mov EDI, buf
            mov ECX, bufLen
            call readn

            ;;;;;;;; Check CLI commands ;;;;;;;;

            mov ESI, buf        ; Load buf to ESI

            ; CMD: exit
            mov EAX, CMD_EXIT
            call strcmp
            jz __cli_exit

            ; Base case, no match
            mov ESI, CMD_UNKNOWN        ; print(CMD_UNKNOWN)
            call printz

            mov ESI, buf                ; print(buf)
            call printz

            mov ESI, NEWLINE            ; print(NEWLINE)
            mov ECX, 1
            call printnz

            jmp __cli_loop      ; Restart loop

        __cli_exit:
            popdw RP        ; Restore RP
            ret

    _start:
        ; Invoke CLI
        call cli

        ; Kill the TPU
        mov EAX, 22
        syscall
