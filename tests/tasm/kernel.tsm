include stdlib.tsm
include string.tsm

section kernel-data
    u32 MAX_MEMORY_ALLOC    0x10000000

section kernel
    ; Cleans up and stops the TPU
    syscall_22:
        mov EAX, 0 ; Indicate success
        hlt

    _kernel_start:
        ; Populate syscall table
        setsyscall 22, syscall_22

        ; Start user program
        uret @0x00040000, @0x01000000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

section data
    strz USERNAME_PROMPT "Enter username: "

    strz WELCOME_MSG "Welcome to TPUOS, "
    strz NEWLINE "\n"

    ; Create space for username
    u32 usernameLen 63
    space username 64 ; n zeroes

section text
    toast:
        pushdw RP       ; Save RP

        ; Prompt user for name
        mov ESI, USERNAME_PROMPT    ; Load welcome message to ESI
        call printz                 ; Print strz USERNAME_PROMPT

        ; Read username
        mov EDI, username       ; Specify where to store the string
        ldw ECX, usernameLen    ; Specify length of buffer
        call readn              ; Read n bytes from stdin
        pushdw EAX              ; Save username length

        ; Write welcome message
        mov ESI, WELCOME_MSG    ; Load welcome message to ESI
        call printz             ; Print strz WELCOME_MSG

        ; Write username
        mov ESI, username   ; Load username to ESI
        popdw ECX           ; Restore username length
        call printnz        ; Print strz username

        ; Write newline
        mov ESI, NEWLINE    ; Load newline to ESI
        mov ECX, 1          ; Length = 1
        call printnz        ; Print strz WELCOME_MSG

        popdw RP        ; Restore RP
        ret

    _start:
        ; Toast the user
        call toast

        ; Kill the TPU
        mov EAX, 22
        syscall
