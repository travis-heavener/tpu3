include stdlib.tsm
include string.tsm

section kernel-data
    u32 MAX_MEMORY_ALLOC    0x10000000

section kernel
    ; Cleans up and stops the TPU
    syscall_22:
        mov EAX, 0 ; Indicate success
        hlt

    _kernel_start:
        ; Populate syscall table
        setsyscall 22, syscall_22

        ; Start user program
        uret @0x00040000, @0x01000000

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

section data
    strz USERNAME_PROMPT "Enter username: "

    strz WELCOME_MSG "Welcome to TPUOS, "
    strz NEWLINE "\n"

    ; Create space for username
    u32 usernameLen 64
    space username 64

section text
    toast:
        pushdw RP       ; Save RP

        ; Prompt user for name
        mov ESI, USERNAME_PROMPT    ; Load welcome message to ESI
        call strlen                 ; Calculate welcome message length
        mov ECX, EAX                ; Save strlen(WELCOME_MSG)
        mov EBX, 1                  ; fd = stdout
        mov EAX, 1                  ; Write() syscall
        syscall

        ; Read username
        mov EAX, 2              ; Read() syscall
        mov EBX, 0              ; fd = stdin
        ldw ECX, usernameLen    ; Specify length of buffer
        mov EDI, username       ; Specify where to store the string
        syscall
        pushdw EAX              ; Save username length

        ; Write welcome message
        mov ESI, WELCOME_MSG    ; Load welcome message to ESI
        call strlen             ; Calculate welcome message length
        mov ECX, EAX            ; Save strlen(WELCOME_MSG)
        mov EBX, 1              ; fd = stdout
        mov EAX, 1              ; Write() syscall
        syscall

        ; Write username
        mov ESI, username   ; Load username to ESI
        popdw ECX           ; Restore username length
        mov EBX, 1          ; fd = stdout
        mov EAX, 1          ; Write() syscall
        syscall

        ; Write newline
        mov ESI, NEWLINE    ; Load newline to ESI
        mov EAX, 1          ; Write() syscall
        mov EBX, 1          ; fd = stdout
        mov ECX, 1          ; Length = 1
        syscall

        popdw RP        ; Restore RP
        ret

    _start:
        ; Toast the user
        call toast

        ; Kill the TPU
        mov EAX, 22
        syscall
